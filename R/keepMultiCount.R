keepMultiCount <- function(bamfilein,bamfileout,chromosomes=NULL,allChromosomes,lenSeq,win=1000,step=100,threshold,pvalueThreshold=0.05,minR=0,limit=0.25){//compute the reads to be kept after filtering
  logitThreshold <- binomial()$linkfun(threshold)
  alignments <- list()
  header <- list()
  writer <- list()
  for (i in c(1:length(bamfilein))){
    alignments[[i]] <- readGAlignments(bamfilein[i],param=ScanBamParam(what=c("cigar")))#read file i
  }
  if (is.null(chromosomes)) chromosomes<-allChromosomes
  keep <- list()
  for (chr in chromosomes){
    message("Chromosome ",chr)
    chromosomeIndex <- which(allChromosomes==chr)
    len <- lenSeq[chromosomeIndex]
    positionPos <- data.frame("group"=c(),"start"=c(),"end"=c(),"sample"=c()) #position of each fragment of positive reads
    positionNeg <- data.frame("group"=c(),"start"=c(),"end"=c(),"sample"=c()) #position of each fragment of negative reads
    index <- list() #the index of each read in the alignment from its index in positive/negative read lists
    nbRead <- c() #number of original reads 
    for (i in c(1:length(bamfilein))){ #compute positionPos and positionNeg for all samples
      alChr <- seqnames(alignments[[i]])==chr
      al <- alignments[[i]][alChr]
      alignments[[i]] <- alignments[[i]][!alChr]
      remove(alChr)
      nbRead <- c(nbRead,length(al))
      index[[i]] <- getIndex(as.vector(strand(al)))
      alPos<-al[strand(al)=="+"]
      pos <- extractAlignmentRangesOnReference(cigar(alPos),pos=start(alPos)) %>% data.frame() %>% dplyr::select(-c(group_name,width))
      remove(alPos)
      pos[["sample"]] <- rep(i,nrow(pos))
      positionPos <- rbind(positionPos,pos)
      remove(pos)
      alNeg<-al[strand(al)=="-"]
      remove(al)
      neg <- extractAlignmentRangesOnReference(cigar(alNeg),pos=start(alNeg)) %>% data.frame() %>% dplyr::select(-c(group_name,width))
      remove(alNeg)
      neg[["sample"]] <- rep(i,nrow(neg))
      positionNeg <- rbind(positionNeg,neg)
      remove(neg)
    } 
    if (minR==0){
      windows <- computeWinCount0(positionPos$start,positionPos$end,positionNeg$start,positionNeg$end,len,win,step,logitThreshold,limit) #compute information in each sliding windows
    }
    else{
      positionPos[["firstW"]] <- ceiling((positionPos$start-win-1+floor((positionPos$end-positionPos$start+1)*limit))/step)
      positionNeg[["firstW"]] <- ceiling((positionNeg$start-win-1+floor((positionNeg$end-positionNeg$start+1)*limit))/step)
      positionPos <-  positionPos[order(positionPos$firstW),] #reorder positionPos following the starting position of each fragment
      positionNeg <-  positionNeg[order(positionNeg$firstW),] #reorder positionNeg following the starting position of each fragment
      windows <- computeWinCount(positionPos$start,positionPos$end,positionNeg$start,positionNeg$end,len,win,step,logitThreshold,minR,limit) #compute information in each sliding windows
    }
    windows$Plus["pvalue"] <- pnorm(windows$Plus$value,lower.tail = FALSE) #compute pvalue for positive windows
    windows$Minus["pvalue"] <- pnorm(windows$Minus$value,lower.tail = FALSE)#compute pvalue for negative windows
    keepWinPos <- filter(windows$Plus, pvalue <= pvalueThreshold)$win # the indices of positive windows to be kept
    keepWinNeg <- filter(windows$Minus, pvalue <= pvalueThreshold)$win # the indices of negative windows to be kept
    remove(windows)
    reads <- keepRead(length(bamfilein),positionPos$start,positionPos$end,positionPos$group,positionPos$sample,positionNeg$start,positionNeg$end,positionNeg$group,positionNeg$sample,keepWinPos,keepWinNeg,len,win,step,limit) #compute index of positive/negative reads to be kept
    keep[[chr]] <- list()
    for (i in c(1:length(bamfilein))){
      keep[[chr]][[i]] <- c(index[[i]]$Pos[unique(reads$Pos[[i]])],index[[i]]$Neg[unique(reads$Neg[[i]])]) %>% sort() #index of reads to be kept
      message("Sample ",i,", number of reads: ",nbRead[i],", number of kept reads: ",length(keep[[chr]][[i]]))
    }
    remove(positionPos)
    remove(positionNeg)
    remove(keepWinPos)
    remove(keepWinNeg)
    remove(reads)
    remove(index)
  }
  remove(alignments)
  return (keep)
}